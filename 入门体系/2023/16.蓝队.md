[TOC]

### 一、日志分析

#### 分类：

1. 系统日志
   1. 系统自带登陆验证服务暴力破解
      1. 内网比较多
      2. 登陆成功/失败事件编号：4624/4625）
      3. **但是有些服务没有日志，比如WMI**
2. 第三方服务日志
   1. web日志：在中间件上
   2. 数据库日志

看攻击的层面去决定看哪个日志

#### web日志：

分类：

1. iis、apache、tomcat

日志记录：

1. ip、时间、请求方法、get请求参数、返回值、放回包长度
2. 一些中间件日志可能**不记录Post参数**

#### 日志分析项目sigma规则

##### ELK：

1. 需要部署到vps上
2. 支持各种系统日志，应用日志分析
3. 支持文件上传分析、本地代理上传分析

##### splunk:

	取代elk趋势

### 二、流量分析

#### 作用：

##### 研发:

	能获取到红队最新魔改的样本，进行流量分析特征，加入规则库/安全开发

##### 攻防对抗：

前提：清楚各个常见后门/websehll的流量特征

1. 之前分析过的一些样本特征，去流量中确认，样本种类
2. 解密流量，知道干了什么

### 三、后门排查

#### 一、排查

##### 入口：

1. 进程运行
2. 网络连接（在linux中，像CS等使用睡眠的不实时的通讯，检测不到）

##### 后门确认：

1. 平台分析
   1. 文件/ip丢过去
2. 人工分析
   1. 流量特征分析
   2. 逆向后门

#### 二、处置

##### 清理+阻断：

1. 清除后门
2. 防火墙设置阻断
   1. 文件名（鸡肋）
   2. 封IP
   3. 封协议

##### 清理权限：

1. 权限维持清理
2. 权限提升清理

##### 入口封锁：

找到后门植入的入口漏洞，修复

1. web入口
2. 其他服务入口
   1. 数据库：（爆破/弱口令、nday）
   2. 系统自带服务：（爆破/弱口令、nday）
3. 管理员自身
   1. 错误下载
   2. 被钓鱼

#### 三、基线检查

扫描服务器，确认还有哪些可能存在安全隐患的点

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/eb8dd872b9434d518b0300a0485c6335.png#pic_center)


### 四、病毒排查

#### 一、挖矿病毒

##### 特征：

1. CPU拉满
2. 有外联url/ip

##### 病毒执行流程：

1. 清除同类挖矿病毒
2. 下载自己的挖矿
3. 执行权限维持

##### 排查&处置：

1. 找到cpu拉满的那个进程/外联的地址，丢平台分析
2. 尝试清除
   1. 清除权限维持
   2. 结束进程，删除
3. 封锁入口

#### 二、勒索病毒

##### 特征：

1. 提示，文件被加密，交赎金

##### 处理：

1. 网上找公开解密方法
2. 去找安全公司、个人有偿解密
3. 个人逆向解密
4. 交钱
5. 重装系统

##### 入口：

1. 系统核弹级漏洞
2. OA等办公系统漏洞

### 五、钓鱼邮件排查

##### 发件人判断：下载eml文件

1. 发件人是正常用户，没有在eml中发现中转邮箱服务器
   1. 可能是蠕虫发送，逆向附件
2. 发现中转邮箱地址，丢平台

##### 附件判断：逆向

### 六、恶意镜像排查

#### 特征：

	攻击者可能直接/通过漏洞，在镜像中加入一个恶意的进程（挖矿/后门....），导致在真实系统上出现一个进程，kill不掉，又找不到文件所在。

#### 处置：

1. 确认有docker运行，并且定位到这个进程是哪个docker运行的
2. 查看这个docker镜像在真实系统上的磁盘目录
3. 以这个目录为基础，找到这个进程文件，删掉

```
docker inspect --format='{{.GraphDiver.Data.LowerDir}}'
```

#### 镜像漏扫项目：

```
https://github.com/aquasecurity/trivy
```

### 七、内存马排查：

#### 排查思路：

1. 根据当前环境猜测可能出现内存马的类型
2. 根据类型，确认选择上面工具
   1. gui的只支持几个传统的
   2. 阿里的内存查看工具，通用

#### 日志排查：

1. 针对所有类型内存马，基于web日志，发现有哪些请求的路径，在源码中不存在
2. 使用Yara，编写规则也可以检测

#### JAVA内存马排查：

##### 内存查看工具：

```
https://github.com/alibaba/arthas
```

1. 加载web的java进程
2. 导出指定的类（如：fliter/sevrlet....）

```
sc 查看JVM已加载的类
```

1. 反编译->定性

   1. 人工代码审计
   2. 丢平台
2. 删除木马类

##### 其他GUI工具：

```
https://github.com/4raln/shell-analyzer
```

原理：

	都是基于上面那个项目，并且所支持查看内存马的类型有限

### 八、rookit后门排查

1. 确认rookit类型，下载同样的rookit，卸载
2. 火绒剑可以查看到隐藏进程，但是网络连接检测不到
3. unhide项目，可以检测到隐藏进程、网络连接

### 九、蓝队恶意程序排查利器Yara

#### 检测范围：

1. 病毒、后门、木马
2. 内存马

#### 检测原理：通过编写规则

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/865e3e1d9bda4c5f81eb938f24cc51d4.png#pic_center)


**高级蓝队干的事情:**

1. 样本逆向分析
2. 提权特征
3. 加入规则

### 十、设备部署

#### 一、入侵检测系统IDS

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/d3f44f371abe4bbebc8c1576767308e5.png#pic_center)


##### NIDS：流量检测系统

项目：

	snort、suricata

原理：

	通过监控编写的流量规则，在流量还没到达主机过程中，筛选可能存在攻击/恶意程序的流量

使用：

1. 使用网上开源规则
2. 分析攻击流量 
3. 提权特征，编写规则

##### HIDS：主机检测系统

项目：

	Elkeid、Wazuh

原理与搭建：

	项目服务端需要部署到vps上，客户端在被检测主机上

作用：

1. 基线检测
2. 日志分析（一些集成ELK）
3. 基于ATT&AK框架的攻击检测
4. 恶意程序扫描

#### 二、WAF

	一个专门管理web应用的应用，自己也会开放一个端口，也有后台管理界面，一般和web应用在一个服务器，也可以不再一起。部署后需要登陆管理界面，加入需要保护的网站。之后它就会介于客户端和网站直接，劫持web流量，根据规则判断，有没有攻击流量，主要检测常规TOP，有些企业版也会支持其他漏洞攻击流量检测。

#### 三、蜜罐

###### 原理：

	是一个应用，也有开放端口，后台管理界面，蓝队人员通过蜜罐管理界面在服务器上开放许多虚假的端口服务并且都是带有漏洞的

###### 作用：

1. 拖延红队时间
2. 捕获分析红队payload，便于画像

#### 四、堡垒机

##### 本质：

	一个运维专用的应用，部署在一台服务器上，运维通过它管理许多台其他服务器等资产，本身这个服务也有漏洞，红队如果拿下它就拿下了很多资产，蓝队人员需要对堡垒机额外注意保护。

### 十、溯源反制

#### 一、溯源

##### 步骤：

IP -> 域名 -> 联系 -> 库/互联网查

##### 获取IP：

1. 恶意程序外联ip
2. 日志分析

##### 获取域名：(域名注册越久，真实性越高)

1. 通过IP -> 反查域名
2. 钓鱼邮件拆解/恶意程序逆向

##### 获取联系：

1. 域名查询，备案查询
2. 恶意程序逆向获取

##### 进一步：

1. 联系 -> 社工库
2. 互联网微信搜一搜

#### 二、反制

##### 前提：

		需要至少知道红队的IP

##### 手段：

未授权的mysql的蜜罐：

1. 利用mysql读文件的功能，红队一旦连接上，就会被读取蓝队指定的文件，可以是一些配置文件：CS的配置，浏览器的缓存..

蚁剑漏洞RCE：有版本限制

1. 修改木马，加入反制代码
2. 新增有反制代码的木马，红队会扫到可能会连

IDE的RCE：jebatins的

1. 虚构一个网站，在源码中故意泄露zip源码文件，当红队打开用IDE进行代码审计，就会触发之前制作好的反制代码

CS:

1. 爆破连接服务端的密码，默认开放50050端口
2. RCE，4.7版本以下
3. 批量伪造后门连接

Goby漏洞的RCE、sqlmap的RCE....

扫描其他应用的未授权如NPS......

### 十一、安全/规则开发

#### 方向：

1. 样本的**各种版本/魔改的各种配置**的流量分析 -> 特征流量提取 -> 规则开发
   1. NIDS规则开发
   2. 脚本开发
2. 样本的**各种版本/魔改**的逆向分析 -> 提取文件特征 -> 规则开发
   1. Yara规则开发
   2. 脚本开发
      1. 思路：使用py/go，服务器上的文件变动 -> 上传到平台分析 -> 获取到危害 -> 实时发送到微信...
3. simga规则开发 - >  整合到elk/splunk日志分析系统