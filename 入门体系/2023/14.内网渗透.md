[TOC]

### 一、域内/域外

**域的作用：**

	简单的内网环境不需要域。当内网主机很多的时候需要一个DC也叫域控统一管理一批内网主机，所以域的出现就是方便复杂内网的管理。并且每一个域都有唯一的域名和外网的域名一样，域下面还可以有子域。

**域账户/个人账户：**

	一台主机（假如是WIN）本身具有SYSTEM、Admin....普通账户，加入域之后多了一个域账户。如果使用域账户登陆，那么做什么事情都会受到DC的控制。但是SYSTEM、Admin是凌驾于域、域外普通账户之上的。

**从域外->域内：**

1. 拿到主机的System/Admin权限（Admin很容易到System）

   因为System是凌驾于一切之上的，可以通过MIMIKaz工具在内存中导出到域账户密码

2. 拿到域账户权限

### 二、域架构

**单域、父子域、域树、域森林：**

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/782156b0d22f44c6898ac9454a46b592.png#pic_center)


注意：

1. 子域dc的dns是父域的dc！
2. 域森林：顶级父域DC和其他级别域DC需要建立信任关系，这样双方就能通讯

### 三、内网通讯

```
+-------------------+-------------------+-------------------+-------------------+
|    应用层         |    传输层         |    网络层         |    网络接口层     |
|  (Application)    |  (Transport)      |  (Internet)       |  (Network Access) |
+-------------------+-------------------+-------------------+-------------------+
| HTTP, FTP, DNS,  | TCP, UDP, SCTP    | IP, ICMP, ARP     | Ethernet, Wi-Fi   |
| SMTP, SSH, etc.  |                   |                   |                   |
+-------------------+-------------------+-------------------+-------------------+
| Socket API        | Socket API        |                   |                   |
+-------------------+-------------------+-------------------+-------------------+
```

#### **背景：**

	至少都有一台可以联通内网的机器的webshell

#### **目的：**

1. C2上线
2. 内网穿透-信息收集-**流量到本地**
   1. 代理节点
   2. 端口映射

#### C2上线：

架构：

1. CS服务器在VPS上
2. CS服务器在自己的内网上（针对这种情况的上线，需要一台vps、工具:frp、nps、chisel）

阻碍与绕过：

1. 无防火墙，策略不严谨，可以通过正/反连接就能上线
2. 有防火墙，策略严谨，非域环境，webshell提权system关闭防火墙
3. 有防火墙，策略严谨，域环境，**隧道技术**
   1. 判断出网协议，是否存在**icmp**，存在可以使用icmp隧道（server、client，需要上传文件到目标2）
   2. ...其他协议隧道，并且c2支持

#### 内网穿透：

**代理节点：**

解决问题：

	vps能够访问目标1且有权限，不能访问目标2，目标1存在目标2网段，在目标1上建立代理节点，设置的代理服务器一般都是vps，然后本机就可以使用profixier代理软件，连接上vps，和目标2进行通讯。

手法：

1. 可以上线C2，直接使用C2建立Socket/http等节点（4a无密码，5有密码）
2. 直接使用哥斯拉、冰蝎weshell也可以建立Socket等其他节点
3. 使用frp、nps、chisel等内网渗透工具也行（server、client，需要上传文件到目标2)
4. neo-reGeorg http代理

##### 端口映射：

解决问题：

	和代理节点类似，差别：端口映射后，访问vps端口 = 访问被映射的目标2的端口

手法：

1. ssh隧道
2. 哥斯拉、冰蝎的webshell也可以http隧道端口映射
3. 使用frp、nps、chisel等内网渗透工具也行

### 四、信息搜集

#### 步骤：

1. 定位当前账户权限
2. 判断被控机是否在内网中
3. 判断是否是存在域环境
4. 确认在域环境中的大概位置、确认DC
   1. 域的普通用户只能看见当前域用户，DC只能看见以下的域用户和DC
5. 查看防护信息：防火墙、杀软、流量检测工具
6. 确认被控机有哪些服务
7. 尝试搜索这些服务的密码

#### 扫描工具：

**内扫：只能在受控机执行**

	扫描受控机的密码凭证等敏感信息

项目：

```
1.HackBrowserData
2.Searchall
3.Pillager
```

##### 外扫：一些可以通过代理流量在攻击机上执行

	扫描网段其他节点信息、域信息

项目：

```
1.FScan
2.Template
3.Adfind
```

域环境：端口扫描命令**setspn**，不受防火墙影响

#### DMZ区域：

	是公司网络架构中，那一块介于不出网内网—互联网中间的缓冲区，也属于内网，一般入口都在这里。

### 五、域横向移动

移动手法抛开网络通讯和利用条件限制，可以移动到域森林的任意一个机器。但是正常情况下，域用户只能和当前域用户和DC通讯，而不能直接跨级。

#### 一、 明文密码 & PTH 

注意：

0. 在win10/2012之后注册表设置，内存中不允许存在明文密码，只允许hash存在

1. admin、system可以获取凭证、域用户不行；
2. system、域用户可以域通讯，admin不行；
3. **admin等非域用户不受DC的域防火墙策略影响；**
4. 命令中用户规范：**计算机\域名/用户名，**计算机名不能空；执行命令的用户是域用户，前面为空，默认当成域用户；有些工具不写也默认是域用户

步骤：

 	1. 扫描确认：内网有哪些主机、这些主机都开放了哪些端口（服务）
 	2. mimikaz等工具，获取受控机的明文密码/hash，可以使用hashcat爆破hash
 	3. 结合凭证和开放的服务，选择采用哪种手法进行喷射（ipc、wmi、SMB、DCOM、WinRs/m、rdp）

##### IPC：开放193、445端口

1. 命令：需要明文
   1. 直接获取到明文
   2. hashcat破解
2. 工具：impacket套件 -> atexec.py文件
   1. **支持hash**
   2. 可以流量代理到本地执行（端口转发、设置代理节点）

##### WMI：开放135、445端口（这个协议的登录，不会在系统日志中留下痕迹）

1. 命令
2. 工具：impacket套件 -> wmiexec.py文件

##### SMB：开放135、445端口

1. 工具：impacket套件 -> smbexec.py文件

##### DCOM：win7以上

1. 工具：impacket套件 -> dcomexec.py文件

##### WinRS、WinRM：开放5986、5985

1. 命令

##### rdp：开放3389

1. 远程桌面，图形化，需要明文，结合流量转发到本地（代理、端口转发）

##### 凭据喷射爆破项目：CrackMapExec

![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/73b9d123f1f84b9ca03c78cbf06d0466.png#pic_center)



作用：

	集成了以上所有的服务，可以指定：一系列内网ip、一种服务、一个hash/密码字典、一个域/非域账户字典，进行喷射，执行xx命令。

支持：

1. **hash**
2. 可以流量代理到本地执行（端口转发、设置代理节点）

#### 二、PTT 攻击不受防火墙影响：

##### MS14068漏洞：

1. 获取一个域用户的SID

2. 受控机上传入exp的exe，输入这个域用户名，明文密码，生成票据

3. mimikatz导入票据

   ```
   mimikatz kerberos::ptc TGT_webadmin@god.org.ccache
   ```

4. 连接上线

   ```
   shell dir \\OWA2010CN-GOD\c$
   ```

##### kekeo将hash->票据：

1. 生成票据

   ```
   shell kekeo "tgt::ask /user:Administrator /domain:xxx/ntlm::xxx" "exit"
   ```

2. 导入票据

   ```
   shell keko "kerberos::ptt TGT_Administrator@xxx@xxx" "exit"
   ```

3. 连接

   ```
   shell dir \\owa2010cn-god\c$
   ```

##### mimikatz查看历史票据：

导出：

```
mimikatz sekurlsa::tickets /export
```

导入：

```
mimikatz kerberos::ppt 票据路径
```

#### 三、凭据攻击思路

1. 明文密码
   1. 服务连接
   2. 失败(防火墙，没服务) --> PTT法1
2. hash
   1. 服务连接
   2. 失败(有服务，无明文) --> 
      1. hashcat破解
      2. 修改注册表，重启
   3. 失败(防火墙，无服务) --> PTT法2

#### 四、委派攻击

**非约束委派：**

1. 查找

   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/591eea4b1a584ae3986d70d90789b530.png#pic_center)


2. DC主动/被动访问委派机器

   1. 被动钓鱼，**可以结合exchange服务**

   2. 主动，打印机漏洞（DC2012以上）

      1. 利用

         ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/7dc8c4c1004b47e987a46df421286721.png#pic_center)


##### 约束委派：

1. 查找

   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/0189eef99e9d4f73aba8cf03b7d34ccb.png#pic_center)


2. 利用

   1. 获取委派用户hash
   2. kekeo 将hash -> 票据
   3. 利用kekeo和s4o，委派用户票据 -> DC票据
   4. 导入DC票据

##### 资源性委派：

查找：

核心：

	![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/36a00fd35e084887b5a2a743eebb3a01.png#pic_center)


1. 在多个机器上创建域的账户 SUID一致

   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/2ad4e75492fd476a9ddeebc5b984bca0.png#pic_center)


2. 是Acount Operators成员

   ![在这里插入图片描述](https://i-blog.csdnimg.cn/direct/790a603ab86f44cbb4665c7001cf51ff.png#pic_center)


利用：

1. 添加一个机器账号，用于票据申请
2. 利用新增的机器账号修改委派属性满足申请访问目标票款
3. 获取新增账号的objectsid
4. 修改data主机委派属性
5. 利用修改后属性申请目标请求票据后导入利用

#### 五、exchange攻击

exchange是win的邮件系统服务

##### 攻击点：

1. nday漏洞打
   1. 需要获取账号密码（域）
   2. 不需要获取的
2. 钓鱼
3. 爆破

##### 思路：

1. 扫描端口587、443....、使用setspn扫
2. 能获取明文账号密码
   1. 需要账密的nday打
      1. 判断版本
         1. 设置代理、本地访问+owa，查看源码有版本信息
   2. 钓鱼
3. 有账号没有密码
   1. 不需要账密的nday打
   2. 爆破
      1. 设置代理，本地bp爆破

#### 六、域控提权漏洞

直接获取当前DC的权限

##### CVE-2020-1472：

1. 不需要用户名密码，win全系列

##### CVE-2021-42278：

1. 需要一个域用户明文密码
2. win全系列

##### CVE-2022-26923：

1. 域用户账号密码
2. 域存在CS证书服务器，可能在DC上
3. win全系列

#### 七、工作组攻击

##### ARP欺骗：

	原理：欺骗目标机、网关，mac是攻击机mac
	
	作用：劫持数据
	
	解决：双方的arp路由表都配置为静态的

##### DNS劫持：

	原理：欺骗目标机的域名解析到不同的ip
	
	作用：钓鱼

#### 八、Linux -> Linux

##### ssh密钥文件登陆：

	ssh有使用密钥文件进行登陆的方式，一般都存在被控机中，可以搜索到

### 六、权限维持

#### 一、域内维持连接

##### SID history：

原理：

	在被控机上将被控机域账号的SID加入到恶意域账号的SID history中，那么这个恶意域账号就能直接访问被加入的域账号了

##### 黄金 & 白银 & 蓝宝石 & 钻石票据：

###### 黄金：用于DC的权限维持

前提：

1. 获取到DC的权限
2. 获取到krbtgt账号的hash（只有DC才有这个账号）

利用：

	1. 在DC上获取krbtgt账号的hash
	1. 直接在目标机器上通过这个账号的hash伪造票据，植入机器
	1. 这个被植入的机器就能直接和DC通讯

###### 白银：用于DC或其他机器的权限维持

前提：

1. 已经获取了这个机器的权限
2. 获取到这个机器的一个机器账号的hash

利用：

1. 在这个机器上再获取一个机器账号的hash
2. 在目标机器上通过这个hash伪造指定服务的票据，植入机器
3. 这个被植入的机器就能直接和机器账号所在机器通讯，通过指定服务

###### 蓝宝石：用于DC的权限维持

前提：

1. 获取到DC的权限
2. 获取到krbtgt账号的hash
3. 获取到目标机器的一个普通域账号的明文密码

利用：

1. 获取到所有所需条件
2. 到目标机器上，使用魔改的impacket->ticket.py，植入申请的票据
3. 这个被植入的机器就能直接和DC通讯

###### 钻石：用于DC的权限维持

前提：蓝宝石一样

利用：

1. 在目标机器上，使用这个机器账号和密码，以及trkbgt的hash，向DC申请一个票据
2. 再重新加密，植入，指定服务
3. 这个被植入的机器就能直接和DC通讯，通过指定服务

###### 对比：

1. 钻石和蓝宝石，属于真实票据，隐秘性更强，但是条件也更多
2. 钻石和白银是指定服务
3. 白银不单只针对DC
4. 钻石机器重启没问题

#### 二、C2后续上线（文件/无文件）

##### 自启动：

1. c2添加到自启动项中
2. 添加一个自启服务，指定执行文件为c2
3. 添加定时任务

##### 指定事件触发：

1. shift沾滞键（需要对方开3389）
   1. 提升权限
   2. 替换沾滞执行文件为c2
   3. 远程连接3389，不需要登陆，本地直接shitf5触发
2. 组策略：修改事件执行为c2
3. 修改屏保程序为c2

##### 文件印像伪造：

原理：

	在cmd中执行某个命令就能触发进程执行，替换这个命令对应的进程为c2（为了隐秘性，改为添加）

#### 三、后门隐藏 | rootkit

##### 放类C2远控：

介于商业远控和C2之间的：

1. gotohttp
2. rustdesk

##### rootkit从表面隐藏远控：(自身也要考虑免杀)

1. 隐藏远控文件
2. 隐藏服务/进程
3. 隐藏注册表
4. 隐藏网络连接
5. 但是隐藏不了流量

项目:R77

#### 四、内存马 & webshell文件隐匿 -> 免杀对抗篇

#### 五、Linux SSH连接维持

##### 添加密码：

1. 支持ssh的软件是openssh，下载一个新的openssh，修改配置文件，加入后门密码，编译，覆盖安装
2. PAM，也和openssh一样，下载个新的，修改配置文件，加入后门密码，编译，覆盖安装

##### PAM添加软连接：

1. 确认是否支持PAM
2. 将sshd服务软链接至8888端口
3. 连接这个端口，任意密码登陆

##### 添加密钥对：

ssh支持密钥对登陆：

1. 在服务端生成公私钥，将私钥保留到本地
2. 在本地端生成公私钥，将公钥保留到服务端

##### 添加后门账号：

	利用root权限，添加新的账号到root组

##### 添加nc反弹计划任务：

##### 替换alias包含nc反弹：

	alias是linux命令中为了管理员方便可以给管理员指定一串命令的别名，执行这个别名就能执行一串指定命令

##### 项目：

```
https://github.com/RuoJi6/HarckerPermKeeper
```

#### 六、linux c2后续上线

1. 添加执行后门计划任务

2. 替换alias为执行后门

#### 七、Linux隐藏后门 & rootkit

项目：

	reptile

效果：

1. 和win的一样
译，覆盖安装
2. PAM，也和openssh一样，下载个新的，修改配置文件，加入后门密码，编译，覆盖安装

##### PAM添加软连接：

1. 确认是否支持PAM
2. 将sshd服务软链接至8888端口
3. 连接这个端口，任意密码登陆

##### 添加密钥对：

ssh支持密钥对登陆：

1. 在服务端生成公私钥，将私钥保留到本地
2. 在本地端生成公私钥，将公钥保留到服务端

##### 添加后门账号：

	利用root权限，添加新的账号到root组

##### 添加nc反弹计划任务：

##### 替换alias包含nc反弹：

	alias是linux命令中为了管理员方便可以给管理员指定一串命令的别名，执行这个别名就能执行一串指定命令

##### 项目：

```
https://github.com/RuoJi6/HarckerPermKeeper
```

#### 六、linux c2后续上线

1. 添加执行后门计划任务

2. 替换alias为执行后门

#### 七、Linux隐藏后门 & rootkit

项目：

	reptile

效果：

1. 和win的一样
2. 高级玩法自带远控，只需考虑rootkit自身免杀